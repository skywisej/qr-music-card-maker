<!DOCTYPE html><html><body style="background:black;color:white;"><pre id="log"></pre>
<script>
const log = (...msg) => document.getElementById("log").textContent += msg.join(" ")+"\n";
log("callback start");

const code     = new URLSearchParams(location.search).get("code");
const verifier = localStorage.getItem("hitster_verifier");
log("code present?", !!code, "verifier present?", !!verifier);

if (!code || !verifier){
  log("Missing code or verifier â€“ reload login");
  location.href = "/qr-music-card-maker/login.html";
  throw "";
}

const data = new URLSearchParams({
  grant_type:    "authorization_code",
  client_id:     "f373adfc90734648bd432988e370ab64",   // same ID
  code,
  redirect_uri:  "https://skywisej.github.io/qr-music-card-maker/login-callback.html",
  code_verifier: verifier
});

function storeToken(tok){
  localStorage.setItem("hitster_token", tok);
  localStorage.setItem("hitster_token_ts", Date.now());
}

(async () => {
try{
  const r   = await fetch("https://accounts.spotify.com/api/token", {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded",
      "Accept": "application/json"          // helps CORS
    },
    body: data
  });
  const raw = await r.text();
  log("TOKEN STATUS", r.status, raw);
  if(!r.ok) throw new Error("token fetch "+r.status);

  const js = JSON.parse(raw);
  storeToken(js.access_token);
  const next = localStorage.getItem("after_auth")
             || "/qr-music-card-maker/cards/html/track1.html";
  localStorage.removeItem("after_auth");
  location.href = next;
}catch(e){
  log("Token exchange failed:", e);
}})();
</script>
</body></html>

    