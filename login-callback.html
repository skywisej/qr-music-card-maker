<!DOCTYPE html><html><body style="background:black;color:white;">
    <script>
    const REDIRECT = "https://skywisej.github.io/qr-music-card-maker/login-callback.html"  
    const params   = new URLSearchParams(location.search);
    const code     = params.get("code");
    const verifier = localStorage.getItem("hitster_verifier");
    console.log("DEBUG code present?", !!code, "verifier present?", !!verifier);
    if (!code || !verifier){
      document.body.textContent = "Login failed. Try again.";
      throw new Error("Missing code or verifier");
    }
    
    const data = new URLSearchParams({
      grant_type:        "authorization_code",
      client_id:         "f373adfc90734648bd432988e370ab64",          // same ID
      code,
      redirect_uri:      REDIRECT,
      code_verifier:     verifier
    });

    const next = localStorage.getItem("after_auth") || "/qr-music-card-maker/cards/html/track1.html";
    localStorage.removeItem("after_auth");
    location.href = next;
    
    fetch("https://accounts.spotify.com/api/token", {
      method: "POST",
      headers: { "Content-Type":"application/x-www-form-urlencoded" },
      body: data
    })
    .then(async r => {
      const txt = await r.text(); // read raw text
      console.log("TOKEN STATUS", r.status, "RAW BODY:", txt);
      try { return JSON.parse(txt); }   // continue as before
      catch { return {}; }
    })  
    .then(js => {
      if (js.access_token){
        localStorage.setItem("hitster_token", js.access_token);
        location.href = "cards/html/track1.html";        // start deck
      }else{
        document.body.textContent = "Token exchange failed.";
      }
    });
    </script></body></html>
    