<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>QR Music Deck • Card</title>
  <script src="https://sdk.scdn.co/spotify-player.js"></script>
  <style>
    html,body{margin:0;height:100%;background:#000;touch-action:manipulation}
    #mask{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;cursor:pointer}
    #mask::before{content:'';width:0;height:0;border-left:110px solid #fff;border-top:70px solid transparent;border-bottom:70px solid transparent}
    #mask.playing::before{border-left-color:#1db954}
    #mask.paused::before,#mask.paused::after{content:'';position:absolute;top:50%;width:30px;height:90px;background:#fff;border:none;transform:translate(-140%,-50%)}
    #mask.paused::after{transform:translate(40%,-50%)}
    #scanBtn{position:absolute;bottom:6%;right:6%;padding:18px 26px;border-radius:50px;background:#1db954;color:#fff;font:16px Helvetica;font-size:1.4rem;border:none;cursor:pointer;display:none}
    #overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.96);z-index:999;align-items:center;justify-content:center;flex-direction:column}
    #video{width:92vw;max-width:520px;border-radius:14px}
    #dbg{position:fixed;top:0;left:0;background:rgba(0,0,0,.7);color:#0f0;font-size:14px;padding:6px 8px;z-index:10000;white-space:pre-wrap;margin:0;max-width:96vw;display:none !important;}
    #toast{position:fixed;left:50%;bottom:8%;transform:translateX(-50%);background:#222;color:#fff;border-radius:999px;padding:10px 18px;font:15px/1.2 Helvetica;display:none}

  </style>
</head>
<body>
  <div id="mask">
    <span style="position:absolute;bottom:12%;width:100%;text-align:center;font:16px/1.2 Helvetica;color:#ccc;">
      Tap anywhere to play / pause
    </span>
  </div>
  <button id="scanBtn">Scan Next</button>

  <div id="overlay">
    <video id="video" playsinline></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <p style="color:#fff;font:18px Helvetica;margin-top:12px;opacity:.9;">Point at next card… (tap anywhere to close)</p>
  </div>

  <pre id="dbg"></pre>
  <div id="toast"></div>

  <script>
    window._hitsterVersion = "v7";
  </script>
  <script>
  const trackUri   = "spotify:track:3qT4bUD1MaWpGrTwcvguhb";
  const TOKEN_KEY  = "hitster_token";
  const TOKEN_TIME = "hitster_token_ts";
  const VERSION_TAG = window._hitsterVersion;

  const dbg = () => {};   // disable debug writes
  const toast = (msg, ms=1800) => {
    const el = document.getElementById('toast');
    el.textContent = msg; el.style.display='block';
    clearTimeout(window._toastT); window._toastT = setTimeout(()=> el.style.display='none', ms);
  };

  function absoluteURL(data){
    if(!data) return "";
    const isAbs = /^https?:\/\//i.test(data);
    let url = isAbs ? data : `${location.origin}/${data.replace(/^\//,'')}`;
    if(!/[?&]v=/.test(url)) { url += (url.includes('?') ? '&' : '?') + VERSION_TAG; }
    return url;
  }

  function needNewToken(){
    const ts = +localStorage.getItem(TOKEN_TIME) || 0;
    return (Date.now() - ts) > 50*60*1000;
  }
  function requireToken(){
    const tok = localStorage.getItem(TOKEN_KEY);
    if(!tok || needNewToken()){
      localStorage.removeItem(TOKEN_KEY);
      localStorage.setItem("after_auth", location.pathname + location.search);
      location.href = location.origin + "/qr-music-card-maker/login.html";
      throw "Redirect to login";
    }
    return tok;
  }
  const token = requireToken();

  let player, deviceId = null;
  let hasStarted = false, isPlaying = false;

  window.onSpotifyWebPlaybackSDKReady = () => {
    player = new Spotify.Player({
      name: 'QR Music Deck',
      volume: 0.8,
      getOAuthToken: cb => cb(localStorage.getItem(TOKEN_KEY))
    });
    player.addListener('ready',      ({ device_id }) => deviceId = device_id);
    player.addListener('not_ready',  () => deviceId = null);
    player.addListener('player_state_changed', s => { if (s) isPlaying = !s.paused; });
    player.connect();
  };

  const mask    = document.getElementById("mask");
  const scanBtn = document.getElementById("scanBtn");
  const overlay = document.getElementById("overlay");
  const videoEl = document.getElementById("video");
  const canvas  = document.getElementById("canvas");
  const ctx     = canvas.getContext("2d");
  let stream = null, rafId = null, detector = null;

  async function ensurePremiumNotice() {
    try {
      const me = await fetch("https://api.spotify.com/v1/me", {
        headers: { "Authorization": "Bearer " + localStorage.getItem(TOKEN_KEY) }
      }).then(r=>r.json());
      if(me && me.product && me.product.toLowerCase() !== 'premium') {
        toast("Spotify Premium required on this account");
      }
    } catch(e){/* ignore */}
  }
  ensurePremiumNotice();

  mask.onclick = () => {
    if (!window._autoplayUnlocked) { try { new AudioContext().resume().then(() => window._autoplayUnlocked = true); } catch {} }
    if (!hasStarted) {
      const start = () => {
        if (!deviceId) { setTimeout(start, 200); return; }
        fetch("https://api.spotify.com/v1/me/player", {
          method:"PUT",
          headers:{"Authorization":"Bearer "+localStorage.getItem(TOKEN_KEY),"Content-Type":"application/json"},
          body: JSON.stringify({ device_ids:[deviceId], play:false })
        }).catch(()=>{}).finally(()=>{
          fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
            method : "PUT",
            headers: {
              "Authorization": "Bearer " + localStorage.getItem(TOKEN_KEY),
              "Content-Type" : "application/json"
            },
            body: JSON.stringify({ uris: [ trackUri ] })
          })
          .then(async r => {
            if (r.status === 401) { dbg("HTTP 401 – token expired"); alert("401: token expired; re-logging in 4 s"); setTimeout(requireToken, 4000); return; }
            if (r.status === 403) {
              const body = await r.json().catch(()=>({}));
              dbg("HTTP 403 – " + (body?.error?.message || "no msg"));
              fetch("https://api.spotify.com/v1/me", { headers: { "Authorization": "Bearer " + localStorage.getItem(TOKEN_KEY) } })
                .then(res => res.json())
                .then(me => dbg(`HTTP 403 – ${body?.error?.message || ""}\nUser: ${me.display_name || "?"}\nproduct: ${me.product || "?"}`))
                .catch(e => dbg("Extra /me fetch failed: " + e));
              setTimeout(()=>scanBtn.style.display="none", 8000);
              return;
            }
            if (r.status !== 204) {
              const txt = await r.text().catch(()=>"(body read err)");
              dbg("HTTP " + r.status + "\n" + txt.slice(0,200));
              alert("Unexpected status " + r.status + " – see green text.");
              return;
            }
            hasStarted = true; isPlaying = true; mask.classList.add("playing"); scanBtn.style.display = "none";
          });
        });
      };
      start(); return;
    }
    player.togglePlay().then(() => {
      isPlaying = !isPlaying;
      mask.classList.toggle("playing", isPlaying);
      mask.classList.toggle("paused",  !isPlaying);
      scanBtn.style.display = isPlaying ? "none" : "block";
    }).catch(err => {
      if (err && err.status === 401) { localStorage.removeItem(TOKEN_KEY); alert("Spotify session expired – please log in again."); requireToken(); }
      else { console.error(err); }
    });
  };

  scanBtn.onclick = async () => {
    overlay.style.display = "flex";
    scanBtn.style.display = "none";
    dbg("Opening camera…");
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" }, width: { ideal: 1280 }, height: { ideal: 720 }, focusMode: "continuous" },
        audio: false
      });
    } catch (e) {
      alert("Camera access denied"); overlay.style.display = "none"; scanBtn.style.display = "block"; dbg(""); return;
    }
    videoEl.srcObject = stream;
    await videoEl.play();
    dbg(`Camera ready (${videoEl.videoWidth}×${videoEl.videoHeight}). Scanning…`);

    if ('BarcodeDetector' in window) {
      try { detector = new window.BarcodeDetector({ formats:['qr_code'] }); } catch(e){ detector = null; }
    }
    if(!detector) {
      await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = "https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js";
        s.onload = resolve; s.onerror = reject; document.head.appendChild(s);
      });
    }

    function stopStream(){ if (rafId) cancelAnimationFrame(rafId), rafId=null; if (stream) { stream.getTracks().forEach(t=>t.stop()); stream=null; } }
    window._stopScanner = stopStream;

    async function tick(){
      dbg(`Scanning… ${Date.now().toString().slice(-4)}`);
      const vw = videoEl.videoWidth  || 640, vh = videoEl.videoHeight || 480;
      if(detector) {
        try {
          const codes = await detector.detect(videoEl);
          if (codes && codes.length) {
            const raw = codes[0].rawValue || ""; const dest = absoluteURL(raw);
            dbg("QR decoded (native):\n" + raw); stopStream(); location.href = dest; return;
          }
        } catch(e){ /* fallthrough to canvas */ }
      }
      canvas.width = vw; canvas.height = vh; const c = canvas.getContext('2d');
      c.drawImage(videoEl, 0, 0, vw, vh);
      const img = c.getImageData(0, 0, vw, vh);
      const code = window.jsQR ? jsQR(img.data, img.width, img.height, { inversionAttempts: "attemptBoth" }) : null;
      if (code && code.data) {
        const raw = code.data; const dest = absoluteURL(raw);
        dbg("QR decoded (jsQR):\n" + raw); stopStream(); location.href = dest; return;
      }
      rafId = requestAnimationFrame(tick);
    }
    tick();
  };

  overlay.onclick = () => { if (window._stopScanner) window._stopScanner(); overlay.style.display = "none"; scanBtn.style.display = "block"; dbg(""); };
  </script>
</body>
</html>