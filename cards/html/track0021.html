<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>QR Music Deck • Card</title>
  <script src="https://sdk.scdn.co/spotify-player.js"></script>
  <style>
    html,body{margin:0;height:100%;background:#000;touch-action:manipulation}
    #mask{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;cursor:pointer}
    #mask::before{content:'';width:0;height:0;border-left:110px solid #fff;border-top:70px solid transparent;border-bottom:70px solid transparent}
    #mask.playing::before{border-left-color:#1db954}
    #mask.paused::before,#mask.paused::after{content:'';position:absolute;top:50%;width:30px;height:90px;background:#fff;border:none;transform:translate(-140%,-50%)}
    #mask.paused::after{transform:translate(40%,-50%)}
    #scanBtn{position:absolute;bottom:6%;right:6%;padding:18px 26px;border-radius:50px;background:#1db954;color:#fff;font:16px Helvetica;font-size:1.4rem;border:none;cursor:pointer;display:none}
    #overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.96);z-index:999;align-items:center;justify-content:center;flex-direction:column}
    #video{width:92vw;max-width:520px;border-radius:14px}
    #dbg{position:fixed;top:0;left:0;background:rgba(0,0,0,.7);color:#0f0;font-size:13px;padding:6px 8px;z-index:10000;white-space:pre-wrap;margin:0;max-width:96vw}
    #toast{position:fixed;left:50%;bottom:8%;transform:translateX(-50%);background:#222;color:#fff;border-radius:999px;padding:10px 18px;font:15px/1.2 Helvetica;display:none}
    #diag{position:fixed;top:0;right:0;background:rgba(255,255,255,.05);color:#9fe1ff;font:12px/1.25 monospace;padding:8px 10px;border-bottom-left-radius:12px;border-left:1px solid #0af2}
    #diag b{color:#fff}
    #relogin{position:fixed;left:6%;bottom:6%;padding:10px 14px;border-radius:10px;border:1px solid #fff3;background:transparent;color:#fff;display:none}
  </style>
</head>
<body>
  <div id="mask">
    <span style="position:absolute;bottom:12%;width:100%;text-align:center;font:16px/1.2 Helvetica;color:#ccc;">
      Tap anywhere to play / pause
    </span>
  </div>
  <button id="scanBtn">Scan Next</button>
  <button id="relogin">Relogin as different user</button>

  <div id="overlay">
    <video id="video" playsinline></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <p style="color:#fff;font:18px Helvetica;margin-top:12px;opacity:.9;">Point at next card… (tap anywhere to close)</p>
  </div>

  <pre id="dbg"></pre>
  <div id="toast"></div>
  <div id="diag">device:<b>–</b>  token:<b>–</b>m  last:<b>–</b>  prod:<b>–</b></div>

  <script>
    window._hitsterVersion = "v7.1";
  </script>
  <script>
  const trackUri   = "spotify:track:4tK4ARuilOrBzwVQK73E0Y";
  const TOKEN_KEY  = "hitster_token";
  const TOKEN_TIME = "hitster_token_ts";
  const VERSION_TAG = window._hitsterVersion;
  const qp = new URLSearchParams(location.search);
  const DEBUG = qp.has("debug");

  const dbg = txt => { document.getElementById('dbg').textContent = txt || ''; };
  const toast = (msg, ms=1800) => {
    const el = document.getElementById('toast');
    el.textContent = msg; el.style.display='block';
    clearTimeout(window._toastT); window._toastT = setTimeout(()=> el.style.display='none', ms);
  };
  const diag = (obj={}) => {
    const el = document.getElementById('diag');
    if (obj.device !== undefined) el.querySelectorAll('b')[0].textContent = obj.device || "–";
    if (obj.tokenMin !== undefined) el.querySelectorAll('b')[1].textContent = obj.tokenMin ?? "–";
    if (obj.last !== undefined) el.querySelectorAll('b')[2].textContent = obj.last || "–";
    if (obj.product !== undefined) el.querySelectorAll('b')[3].textContent = obj.product || "–";
  };

  function absoluteURL(data){
    if(!data) return "";
    const isAbs = /^https?:\/\//i.test(data);
    let url = isAbs ? data : `${location.origin}/${data.replace(/^\//,'')}`;
    if(!/[?&]v=/.test(url)) { url += (url.includes('?') ? '&' : '?') + VERSION_TAG; }
    return url;
  }

  function needNewToken(){
    const ts = +localStorage.getItem(TOKEN_TIME) || 0;
    return (Date.now() - ts) > 50*60*1000;
  }
  function requireToken(){
    const tok = localStorage.getItem(TOKEN_KEY);
    if(!tok || needNewToken()){
      localStorage.removeItem(TOKEN_KEY);
      localStorage.setItem("after_auth", location.pathname + location.search);
      location.href = location.origin + "/qr-music-card-maker/login.html";
      throw "Redirect to login";
    }
    return tok;
  }
  const token = requireToken();
  const tokenAgeMin = Math.floor((Date.now() - (+localStorage.getItem(TOKEN_TIME)||0))/60000);
  diag({ tokenMin: tokenAgeMin });

  let player, deviceId = null;
  let hasStarted = false, isPlaying = false;

  window.onSpotifyWebPlaybackSDKReady = () => {
    player = new Spotify.Player({
      name: 'QR Music Deck',
      volume: 0.8,
      getOAuthToken: cb => cb(localStorage.getItem(TOKEN_KEY))
    });
    player.addListener('ready',      ({ device_id }) => { deviceId = device_id; diag({ device: (deviceId||"–").slice(0,8) }); });
    player.addListener('not_ready',  () => { deviceId = null; diag({ device: "–" }); });
    player.addListener('player_state_changed', s => { if (s) isPlaying = !s.paused; });
    player.connect();
  };

  const mask    = document.getElementById("mask");
  const scanBtn = document.getElementById("scanBtn");
  const overlay = document.getElementById("overlay");
  const videoEl = document.getElementById("video");
  const canvas  = document.getElementById("canvas");
  const relogin = document.getElementById("relogin");
  let stream = null, rafId = null, detector = null;

  relogin.onclick = () => {
    localStorage.removeItem(TOKEN_KEY);
    localStorage.removeItem(TOKEN_TIME);
    localStorage.setItem("after_auth", location.pathname + location.search);
    location.href = location.origin + "/qr-music-card-maker/login.html?show_dialog=1";
  };
  if (DEBUG) relogin.style.display = "block";

  async function whoAmI() {
    try {
      const r = await fetch("https://api.spotify.com/v1/me", { headers: { "Authorization": "Bearer " + localStorage.getItem(TOKEN_KEY) } });
      const ctype = r.headers.get("content-type") || "";
      const body = await r.text();
      let product = "?";
      if (ctype.includes("application/json")) {
        try { product = (JSON.parse(body).product || "?"); } catch {}
      }
      diag({ product });
      if (DEBUG) dbg(`me status ${r.status} ctype ${ctype}\n` + body.slice(0,240));
    } catch(e){
      if (DEBUG) dbg("whoAmI failed: " + e);
    }
  }
  whoAmI();

  mask.onclick = () => {
    if (!window._autoplayUnlocked) { try { new AudioContext().resume().then(() => window._autoplayUnlocked = true); } catch {} }
    if (!hasStarted) {
      const start = () => {
        if (!deviceId) { setTimeout(start, 200); return; }
        fetch("https://api.spotify.com/v1/me/player", {
          method:"PUT",
          headers:{"Authorization":"Bearer "+localStorage.getItem(TOKEN_KEY),"Content-Type":"application/json"},
          body: JSON.stringify({ device_ids:[deviceId], play:false })
        }).catch(()=>{}).finally(()=>{
          fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
            method : "PUT",
            headers: {
              "Authorization": "Bearer " + localStorage.getItem(TOKEN_KEY),
              "Content-Type" : "application/json"
            },
            body: JSON.stringify({ uris: [ trackUri ] })
          })
          .then(async r => {
            diag({ last: r.status });
            if (r.status === 401) { dbg("HTTP 401 – token expired"); alert("401: token expired; re-logging in"); relogin.click(); return; }
            if (r.status === 403) {
              const ctype = r.headers.get("content-type") || "";
              const txt = await r.text().catch(()=>"(read err)");
              // safer: only parse JSON if header says so
              let message = "";
              if (ctype.includes("application/json")) {
                try { message = (JSON.parse(txt)?.error?.message) || ""; } catch {}
              }
              dbg("HTTP 403 – " + (message || "no msg") + "\nctype: " + ctype + "\n" + txt.slice(0,200));
              setTimeout(()=>scanBtn.style.display="none", 8000);
              return;
            }
            if (r.status !== 204) {
              const txt = await r.text().catch(()=>"(body read err)");
              dbg("HTTP " + r.status + "\n" + txt.slice(0,200));
              alert("Unexpected status " + r.status + " – see green text.");
              return;
            }
            hasStarted = true; isPlaying = true; mask.classList.add("playing"); scanBtn.style.display = "none";
          });
        });
      };
      start(); return;
    }
    player.togglePlay().then(() => {
      isPlaying = !isPlaying;
      mask.classList.toggle("playing", isPlaying);
      mask.classList.toggle("paused",  !isPlaying);
      scanBtn.style.display = isPlaying ? "none" : "block";
    }).catch(err => {
      dbg("togglePlay failed: " + (err?.message||err));
      if (err && err.status === 401) { relogin.click(); }
    });
  };

  scanBtn.onclick = async () => {
    overlay.style.display = "flex";
    scanBtn.style.display = "none";
    dbg("Opening camera…");
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" }, width: { ideal: 1280 }, height: { ideal: 720 }, focusMode: "continuous" },
        audio: false
      });
    } catch (e) {
      alert("Camera access denied"); overlay.style.display = "none"; scanBtn.style.display = "block"; dbg(""); return;
    }
    const videoEl = document.getElementById("video");
    const canvas  = document.getElementById("canvas");
    videoEl.srcObject = stream;
    await videoEl.play();
    dbg(`Camera ready (${videoEl.videoWidth}×${videoEl.videoHeight}). Scanning…`);

    if ('BarcodeDetector' in window) {
      try { detector = new window.BarcodeDetector({ formats:['qr_code'] }); } catch(e){ detector = null; }
    }
    if(!detector) {
      await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = "https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js";
        s.onload = resolve; s.onerror = reject; document.head.appendChild(s);
      });
    }

    function stopStream(){ if (rafId) cancelAnimationFrame(rafId), rafId=null; if (stream) { stream.getTracks().forEach(t=>t.stop()); stream=null; } }
    window._stopScanner = stopStream;

    async function tick(){
      dbg(`Scanning… ${Date.now().toString().slice(-4)}`);
      const vw = videoEl.videoWidth  || 640, vh = videoEl.videoHeight || 480;
      if(detector) {
        try {
          const codes = await detector.detect(videoEl);
          if (codes && codes.length) {
            const raw = codes[0].rawValue || ""; const dest = absoluteURL(raw);
            dbg("QR decoded (native):\n" + raw); stopStream(); location.href = dest; return;
          }
        } catch(e){ /* fallthrough to canvas */ }
      }
      canvas.width = vw; canvas.height = vh; const c = canvas.getContext('2d');
      c.drawImage(videoEl, 0, 0, vw, vh);
      const img = c.getImageData(0, 0, vw, vh);
      const code = window.jsQR ? jsQR(img.data, img.width, img.height, { inversionAttempts: "attemptBoth" }) : null;
      if (code && code.data) {
        const raw = code.data; const dest = absoluteURL(raw);
        dbg("QR decoded (jsQR):\n" + raw); stopStream(); location.href = dest; return;
      }
      rafId = requestAnimationFrame(tick);
    }
    tick();
  };

  if (DEBUG) { document.getElementById("dbg").style.display="block"; document.getElementById("diag").style.display="block"; }
  </script>
</body>
</html>