<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title></title>
  <script src="https://sdk.scdn.co/spotify-player.js"></script>
  <style>
    html,body{
      margin:0;
      height:100%;
      background:black;
    }
    #mask{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }
    /* Play triangle */
    #mask::before{
      content:'';
      width:0;
      height:0;
      border-left:110px solid white;
      border-top:70px solid transparent;
      border-bottom:70px solid transparent;
    }
    /* While playing, triangle goes Spotify green */
    #mask.playing::before { 
      border-left-color:#1db954;
    }
    /* Pause icon: two vertical bars */
    #mask.paused::before,
    #mask.paused::after{
      content:'';
      position:absolute;
      top:50%;
      width:30px;         /* bar width */
      height:90px;        /* bar height */
      background:white;
      border:none;        /* remove triangle border */
      transform:translate(-140%,-50%);   /* left bar */
    }
    #mask.paused::after{
      transform:translate(40%,-50%);     /* right bar */
    }
  </style>
</head>

<body>
  <div id="mask">
    <span style="
      position:absolute;
      bottom:12%;
      width:100%;
      text-align:center;
      font:16px/1.2 'Helvetica';
      color:#ccc;">
      Tap anywhere to play / pause
    </span>
  </div>

  <!-- Scan Next button (shown when paused) -->
  <button id="scanBtn"
          style="
          position:absolute;
          bottom:6%;
          right:6%;
          padding:18px 26px;
          border-radius:50px;
          background:#1db954;
          color:#fff;
          font:16px Helvetica;
          font-size:1.4rem;
          border:none;
          cursor:pointer;
          display:none;">
    Scan Next
  </button>

  <!-- Camera overlay (opens after tapping Scan Next) -->
  <div id="overlay" style="display:none;position:fixed;inset:0;
        background:rgba(0,0,0,0.9);z-index:999;
        align-items:center;justify-content:center;flex-direction:column;">
    <video id="video" playsinline style="width:90%;max-width:420px;"></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <p style="color:#fff;font:18px Helvetica;margin-top:12px;">Point at next card… (tap anywhere to close)</p>
  </div>

  <!-- Tiny overlay for debug text (what jsQR decoded) -->
  <pre id="dbg" style="
        position:fixed;top:0;left:0;
        background:rgba(0,0,0,.7);color:#0f0;
        font-size:14px;padding:6px 8px;
        z-index:10000;white-space:pre-wrap;margin:0;"></pre>

  <!-- jsQR (correct CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <script>
  /* -------------------------------------------------
   CONSTANTS / HELPERS
  -------------------------------------------------- */
  const trackUri   = "spotify:track:4Dvkj6JhhA12EX05fT7y2e";   // replaced by Python
  const TOKEN_KEY  = "hitster_token";
  const TOKEN_TIME = "hitster_token_ts";
  const VERSION_TAG  = "v4";       // bump this when you push a new build

  const dbg = txt => { document.getElementById('dbg').textContent = txt || ''; };

  /* Convert relative URLs to absolute + append ?v=… for cache-busting */
  function absoluteURL (data) {
    if (!data) return "";
    let url = data.startsWith("http")
              ? data  
              : `${location.origin}/${data.replace(/^\//, "")}`;
    const sep = url.includes("?") ? "&" : "?";
    return `${url}${sep}${VERSION_TAG}`;
  }            

  /* Token helpers */
  function needNewToken(){
    const ts = +localStorage.getItem(TOKEN_TIME) || 0;
    return (Date.now() - ts) > 50*60*1000;   // > 50 min
  }
  function requireToken () {
    const tok = localStorage.getItem(TOKEN_KEY);
    if (!tok || needNewToken()) {
      localStorage.removeItem(TOKEN_KEY);
      localStorage.setItem("after_auth", location.pathname + location.search);
      location.href = location.origin + "/qr-music-card-maker/login.html";
      throw "Redirect to login";
    }
    return tok;
  }
  const token = requireToken();

  /* -------------------------------------------------
   Spotify Web Playback SDK setup
  -------------------------------------------------- */
  let player, deviceId = null;
  let hasStarted = false, isPlaying = false;

  window.onSpotifyWebPlaybackSDKReady = () => {
    player = new Spotify.Player({
      name: 'QR Music Deck',
      volume: 0.8,
      getOAuthToken: cb => cb(localStorage.getItem(TOKEN_KEY))
    });
    player.addListener('ready',      ({ device_id }) => deviceId = device_id);
    player.addListener('not_ready',  () => deviceId = null);
    player.addListener('player_state_changed', s => { if (s) isPlaying = !s.paused; });
    player.connect();
  };

  /* -------------------------------------------------
   ELEMENT HANDLES
  -------------------------------------------------- */
  const mask    = document.getElementById("mask");
  const scanBtn = document.getElementById("scanBtn");
  const overlay = document.getElementById("overlay");
  const videoEl = document.getElementById("video");
  const canvas  = document.getElementById("canvas");
  const ctx     = canvas.getContext("2d");
  let stream = null, rafId = null;

  /* -------------------------------------------------
   PLAY / PAUSE (main triangle)
  -------------------------------------------------- */
  mask.onclick = () => {
    /* 1️⃣ unlock autoplay on first gesture (iOS) */
    if (!window._autoplayUnlocked) {
      try { new AudioContext().resume().then(() => window._autoplayUnlocked = true); } catch {}
    }

    /* 2️⃣ first click → start playback via Web API */
    if (!hasStarted) {
      const start = () => {
        if (!deviceId) { setTimeout(start, 200); return; }

        fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
          method: "PUT",
          headers: {
            "Authorization": "Bearer " + localStorage.getItem(TOKEN_KEY),
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ uris: [ trackUri ] })
        })
        .then(async r => {
          if (r.status === 401) {
            dbg("HTTP 401");          
            alert("401 Unauthorized → token really expired; re-logging in 4 s...");
            localStorage.removeItem(TOKEN_KEY);
            setTimeout(requireToken, 4000);                            // redirects
            return;
          }
          if (r.status === 403) {
            dbg("HTTP 403"); 
            alert("403 Forbidden → Spotify won't start playback. Pausing 4 s...");
            setTimeout(()=>scanBtn.style.display="none", 4000);;           // stop the loop
            return;
          }
          if (r.status !== 204) {
            dbg("HTTP " + r.status);
            const txt = await r.text();
            alert(`Unexpected status ${r.status}\n${txt.slice(0,120)}`);
            return;
          }
          /* 204 No-Content → success */
          hasStarted = true;
          isPlaying  = true;
          mask.classList.add("playing");
          scanBtn.style.display = "none";
        })
        .catch(console.error);
      };
      start();
      return;
    }

    /* 3️⃣ subsequent clicks → toggle pause/play */
    player.togglePlay().then(() => {
      isPlaying = !isPlaying;
      mask.classList.toggle("playing", isPlaying);
      mask.classList.toggle("paused",  !isPlaying);
      scanBtn.style.display = isPlaying ? "none" : "block";
    })
    .catch(err => {
      if (err && err.status === 401) {
        localStorage.removeItem(TOKEN_KEY);
        alert("Spotify session expired – please log in again.");
        requireToken();
      } else { console.error(err); }
    });
  };

  /* -------------------------------------------------
   SCAN-NEXT OVERLAY
  -------------------------------------------------- */
  scanBtn.onclick = async () => {
    overlay.style.display = "flex";
    scanBtn.style.display = "none";
    dbg("Opening camera…");

    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: "environment" },
          width:  { ideal: 1280 },
          height: { ideal: 720  }
        }
      });
    } catch (e) {
      alert("Camera access denied");
      overlay.style.display = "none";
      scanBtn.style.display = "block";
      dbg("");
      return;
    }

    videoEl.srcObject = stream;
    await videoEl.play();
    dbg(`Camera ready (${videoEl.videoWidth}×${videoEl.videoHeight}). Scanning…`);

    function tick() {
      // live heartbeat so you know we’re looping
      dbg(`Scanning… ${Date.now().toString().slice(-4)}`);

      const vw = videoEl.videoWidth  || 640;
      const vh = videoEl.videoHeight || 480;
      canvas.width  = vw;
      canvas.height = vh;

      ctx.drawImage(videoEl, 0, 0, vw, vh);

      const img = ctx.getImageData(0, 0, vw, vh);
      const code = jsQR(img.data, img.width, img.height, { inversionAttempts: "attemptBoth" });

      if (code) {
        const raw = code.data || "";
        const dest = absoluteURL(raw);
        dbg("QR decoded:\n" + raw);
        stopStream();
        location.href = dest;   // jump to the next card
        return;
      }
      rafId = requestAnimationFrame(tick);
    }
    tick();
  };

  /* close overlay on tap */
  overlay.onclick = () => {
    stopStream();
    overlay.style.display = "none";
    scanBtn.style.display = "block";
    dbg("");
  };

  /* helper to stop camera & loop */
  function stopStream() {
    if (rafId) cancelAnimationFrame(rafId), rafId = null;
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
  }
  </script>
</body>
</html>
