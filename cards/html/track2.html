<!DOCTYPE html>
<html>
<head><meta charset="utf-8"><title></title>
<script src="https://sdk.scdn.co/spotify-player.js"></script>
<style>
  html,body{
    margin:0;
    height:100%;
    background:black;}
  #mask{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;}
  #mask::before{
    content:'';
    width:0;
    height:0;
    border-left:80px solid white;
    border-top:50px solid transparent;
    border-bottom:50px solid transparent;}
  #mask.playing::before { 
    border-left-color:#1db954; }   /* triangle turns Spotify green while playing */
  #mask.paused::before  { 
    content:'';             /* ▐▐ pause icon when paused */
    width:40px; height:40px;
    box-shadow:13px 0 0 0 white,   /* two white bars */
               35px 0 0 0 white;
    border:none;}   
</style>
</head>
<body>
<div id="mask">
  <span style="
    position:absolute;
    bottom:12%;
    width:100%;
    text-align:center;
    font:16px/1.2 'Helvetica';
    color:#ccc;">
  Tap anywhere to play / pause  
  </span>
</div>

<script>
  const trackUri = "spotify:track:5Z01UMMf7V1o0MzF86s6WJ";          // replaced by Python
  const token    = localStorage.getItem("hitster_token");
  requireToken();
  function requireToken(){
  /* If no token (or removed after 401) redirect to login.html */
  if (!localStorage.getItem("hitster_token")){
    localStorage.setItem("after_auth", location.pathname);
    location.href = location.origin + "/qr-music-card-maker/login.html";
    throw "Redirecting to login…";
  }
}
  if (!token){
    // save the path we actually wanted
    localStorage.setItem("after_auth", location.pathname);
    location.href = location.origin + "/qr-music-card-maker/login.html";
  }
  
  let player, deviceId = null;
  let hasStarted = false;     // did we already send the first play?
  let isPlaying  = false;     // current state
  
  window.onSpotifyWebPlaybackSDKReady = () => {
    player = new Spotify.Player({
      name: 'Hitster Deck',
      volume: 0.8,
      getOAuthToken: cb => cb(token)
    });
  
    player.addListener('ready', ({ device_id }) => deviceId = device_id);
    player.addListener('player_state_changed', s => {
      /* keep isPlaying in sync with SDK */
      if (s) isPlaying = !s.paused;
    });
  
    player.connect();
  };
  
const mask = document.getElementById('mask');
mask.onclick = () => {
  /* Safari autoplay helper: unlock audio the first time */
  if (typeof window._autoplayUnlocked === "undefined") {
    try {
      const ctx = new AudioContext();
      ctx.resume().then(() => { window._autoplayUnlocked = true; });
    } catch {}
  }

  if (!hasStarted) {
    /* FIRST click – start track via Web API */
    const waitForDevice = () => {
      if (deviceId){
        fetch("https://api.spotify.com/v1/me/player/play?device_id="+deviceId,{
          method:"PUT",
          headers:{
            "Authorization":"Bearer "+token,
            "Content-Type":"application/json"
          },
          body: JSON.stringify({uris:[ trackUri ]})
        })
        .then(r => {
          if (r.status === 401 || r.status === 403){
           /* Token has expired or was revoked – wipe and re‑login */
            localStorage.removeItem("hitster_token");
            alert("Spotify session expired – please log in again.");
            requireToken();
          }
        })
        .catch(console.error);
        hasStarted = true;
        isPlaying  = true;
        mask.classList.add("playing");
      } else { setTimeout(waitForDevice,200); }
    };
    waitForDevice();
  } else {
    /* Subsequent clicks – toggle pause / play */
    player.togglePlay().then(() => {
      isPlaying = !isPlaying;
      mask.classList.toggle("playing", isPlaying);
      mask.classList.toggle("paused",  !isPlaying);
    }).catch(console.error);
  }
};
  </script>
  
</body>
</html>
