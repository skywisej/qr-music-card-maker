<!DOCTYPE html>
<html>
<head><meta charset="utf-8"><title></title>
<script src="https://sdk.scdn.co/spotify-player.js"></script>
<style>
  html,body{
    margin:0;
    height:100%;
    background:black;}
  #mask{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;}
  #mask::before{
    content:'';
    width:0;
    height:0;
    border-left:110px solid white;
    border-top:70px solid transparent;
    border-bottom:70px solid transparent;}
  #mask.playing::before { 
    border-left-color:#1db954; }   /* triangle turns Spotify green while playing */
/* Pause icon: two vertical bars */
  #mask.paused::before,
  #mask.paused::after{
    content:'';
    position:absolute;
    top:50%;                       /* center vertically */
    width:30px;        /* bar width */
    height:90px;       /* bar height */
    background:white;
    border:none;      /* kill the old triangle border */
    transform:translate(-140%,-50%);   /* left bar */
  }
  #mask.paused::after{
    transform:translate(40%,-50%);     /* right bar */
  }   
</style>
<script src="https://cdn.jsdeliver.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
</head>
<body>
<div id="mask">
  <span style="
    position:absolute;
    bottom:12%;
    width:100%;
    text-align:center;
    font:16px/1.2 'Helvetica';
    color:#ccc;">
  Tap anywhere to play / pause  
  </span>
</div>

<!-- Scan Next button -->
<button id="scanBtn"
        style="
        position:absolute;
        bottom:6%;
        right:6%;
        padding:18px 26px;
        border-radius:50px;
        background:#1db954;
        color:#fff;
        font:16px Helvetica;
        font-size: 1.4rem;
        border:none;
        cursor:pointer;
        display:none;">
  Scan Next
</button>

<!-- Camera overlay -->
<div id="overlay" style="display:none;position:fixed;inset:0;
      background:rgba(0,0,0,0.9);z-index:999;
      align-items:center;justify-content:center;">
  <video id="video" playsinline style="width:90%;max-width:420px;"></video>
  <canvas id="canvas" style="display:none;"></canvas>
  <p style="color:#fff;font:18px Helvetica;margin-top:12px;">Point at next card…</p>
</div>

<script>
/* ------- CONSTANTS / HELPERS ------- */
const trackUri = "SPOTIFY_TRACK_URI";               // replaced by Python
/* ---------- TOKEN HANDLING ---------- */
const TOKEN_KEY   = "hitster_token";
const TOKEN_TIME  = "hitster_token_ts";

/* helper */
function needNewToken(){
  const ts = +localStorage.getItem(TOKEN_TIME) || 0;
  return (Date.now() - ts) > 50*60*1000;   // > 50 min
}
function storeToken(tok){
  localStorage.setItem(TOKEN_KEY, tok);
  localStorage.setItem(TOKEN_TIME, Date.now());
}
function requireToken(){
  const t = localStorage.getItem(TOKEN_KEY);
  if (!t || needNewToken()){
    localStorage.removeItem(TOKEN_KEY);    // drop old/absent token
    localStorage.setItem("after_auth", location.pathname);
    location.href = location.origin + "/qr-music-card-maker/login.html";
    throw "Redirect";
  }
  return t;
}
const token = requireToken();              // ← replaces the old lookup

/* ------- Spotify Web Playback SDK ------- */
let player, deviceId = null;
let hasStarted = false, isPlaying = false;
window.onSpotifyWebPlaybackSDKReady = () => {
  player = new Spotify.Player({
    name: 'QR Music Deck',
    volume: 0.8,
    getOAuthToken: cb => cb(localStorage.getItem("hitster_token"))
  });
  player.addListener('ready',   ({ device_id }) => deviceId = device_id);
  player.addListener('not_ready', () => deviceId = null);
  player.addListener('player_state_changed', s => { if(s) isPlaying = !s.paused; });
  player.connect();
};

/* ------- ELEMENTS ------- */
const mask    = document.getElementById("mask");
const scanBtn = document.getElementById("scanBtn");
const overlay = document.getElementById("overlay");
const video   = document.getElementById("video");
const canvas  = document.getElementById("canvas");
const ctx     = canvas.getContext("2d");
let stream, loopId;

/* ------- PLAY / PAUSE CLICK HANDLER ------- */
mask.onclick = () => {
  /* 1️⃣ unlock autoplay on first gesture (Safari) */
  if(!window._autoplayUnlocked){
    try{ new AudioContext().resume().then(()=>window._autoplayUnlocked=true);}catch{}
  }

  /* 2️⃣ first click on this card: start playback via Web API */
  if(!hasStarted){
    const start = () => {
      if(!deviceId){ setTimeout(start,200); return; }

      fetch("https://api.spotify.com/v1/me/player/play?device_id="+deviceId,{
        method:"PUT",
        headers:{
          "Authorization":"Bearer "+localStorage.getItem("hitster_token"),
          "Content-Type":"application/json"
        },
        body: JSON.stringify({ uris:[ trackUri ] })
      })
      .then(r=>{
        if(r.status===401||r.status===403){     /* token expired */
          localStorage.removeItem("hitster_token");
          alert("Spotify session expired – please log in again.");
          requireToken();                       /* redirects */
          return;
        }
        hasStarted = true;
        isPlaying  = true;
        mask.classList.add("playing");
        scanBtn.style.display="none";
      })
      .catch(console.error);
    };
    start();
    return;
  }

  /* 3️⃣ toggle pause / play after first start */
  player.togglePlay().then(()=>{
    isPlaying = !isPlaying;
    mask.classList.toggle("playing", isPlaying);
    mask.classList.toggle("paused",  !isPlaying);
    scanBtn.style.display = isPlaying ? "none" : "block";
  })
  .catch(err=>{
    if(err && err.status===401){
      localStorage.removeItem("hitster_token");
      alert("Spotify session expired – please log in again.");
      requireToken();
    }else{ console.error(err); }
  });
};

/* ------- SCAN‑NEXT CAMERA OVERLAY ------- */
scanBtn.onclick = async ()=>{
  overlay.style.display="flex";
  scanBtn.style.display="none";
  try{
    stream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:"environment"} });
  }catch(e){
    alert("Camera access denied"); overlay.style.display="none"; return;
  }
  video.srcObject = stream; await video.play();
  canvas.width  = video.videoWidth;  canvas.height = video.videoHeight;

const tick = () => {
  /* draw the live frame */
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  /* down-scale for speed and try both polarities */
  const scale = 0.6;                     // 60 % of full frame
  const w = canvas.width  * scale;
  const h = canvas.height * scale;
  const frame = ctx.getImageData(0, 0, w, h);
  const qr   = jsQR(frame.data, w, h, { inversionAttempts: "attemptBoth" });

  if (qr) {
    /* >>> FOUND a QR code <<< */
    cancelAnimationFrame(loopId);
    stream.getTracks().forEach(t => t.stop());
    location.href = qr.data;             // go to the next track page
    return;
  }
  loopId = requestAnimationFrame(tick);  // continue scanning
};
  tick();
};

/* close overlay on tap */
overlay.onclick = ()=>{
  if(stream) stream.getTracks().forEach(t=>t.stop());
  cancelAnimationFrame(loopId);
  overlay.style.display="none";
  scanBtn.style.display="block";
};
</script>

  
</body>
</html>
